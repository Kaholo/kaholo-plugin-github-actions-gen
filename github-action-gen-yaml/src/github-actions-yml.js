const yaml = require('js-yaml');

class GithubActionsYml{

  constructor(name){
    this.yml = {
      name: name,
      on : {},
      jobs : {}
    };
  }

  setTriggers(results){
    const self = this;
    results.filter(result=>result.type=="pipeline-trigger").forEach(triggerResult=>{
      const triggerType = triggerResult.data.type;
      const triggerOptions = triggerResult.data.options;
      self.yml.on[triggerType] = triggerOptions;
    })
    
  }

  setJobs(results){
    const self = this;
    
    results.filter(result=>result.type=="job").forEach(jobResult=>{  
      const jobId = jobResult.data.id;
      const job = jobResult.data.options;

      job.steps = results.filter(result=>result.type=="step" && result.data.job==jobId).map(stepResult=>{
        return stepResult.data.step_options;
      });
      self.yml.jobs[jobId] = job
    })
    
  }

  toString(){
    const yamlString = 
    `# This is an autogenerated GitHub Actions yml
# By Kaholo :)
#
${yaml.safeDump(this.yml,{indent: 2})}
`;
    return yamlString;
  }
}

module.exports = GithubActionsYml;